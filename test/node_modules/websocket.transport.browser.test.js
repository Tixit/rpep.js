
var testUtils = require("testUtils")

var json = require("../../serialization/json")
var wsBrowser = require("../../transport/ws.browser")
var msgpack = require('../../serialization/msgpack')

module.exports = function() {
    this.timeout(5000)
    
    var clientTests = require('rpep.client.test')

    var testOptions = {
        clientErrorOptions: ['localhost', 6080],
        clientError: "Connection couldn\'t be opened: \nError: Websocket error event (probably means the connection couldn\'t be made or has been closed)",
        listenerErrorOptions: ['notAValidPort'], listenerError: "listen EACCES notAValidPort",
        rawMessages: testUtils.createRawMessageTests(json),
        nextClientOptions: function(lastOptions) {
            if(lastOptions === undefined) lastOptions = testOptions.clientErrorOptions
            return ['localhost', lastOptions[1]+1]
        }
    }



    var that = this
    this.test('rpep browser client with websockets', clientTests(wsBrowser, json, testOptions)).complete.then(function() {
        function getTransport() {
            return wsBrowser()
        }
                
        testOptions.rawMessages = testUtils.createRawMessageTests(msgpack)
        testOptions.clientErrorOptions[1] = 7080
        testOptions.nextClientOptions = function(lastOptions) {
            if(lastOptions === undefined) lastOptions = testOptions.clientErrorOptions
            return ['localhost', lastOptions[1]+1, {binaryType:'arraybuffer'}]
        }

        that.test('rpep browser client with binary websockets', clientTests(getTransport, msgpack, testOptions))
    })

}