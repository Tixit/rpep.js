!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.rpep=t():e.rpep=t()}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=2)}([function(e,t,n){(function(r){var i;!function(s){function o(){this._events={},this._conf&&a.call(this,this._conf)}function a(e){e?(this._conf=e,e.delimiter&&(this.delimiter=e.delimiter),this._maxListeners=e.maxListeners!==s?e.maxListeners:d,e.wildcard&&(this.wildcard=e.wildcard),e.newListener&&(this.newListener=e.newListener),e.verboseMemoryLeak&&(this.verboseMemoryLeak=e.verboseMemoryLeak),this.wildcard&&(this.listenerTree={})):this._maxListeners=d}function c(e,t){var n="(node) warning: possible EventEmitter memory leak detected. "+e+" listeners added. Use emitter.setMaxListeners() to increase limit.";if(this.verboseMemoryLeak&&(n+=" Event name: "+t+"."),void 0!==r&&r.emitWarning){var i=new Error(n);i.name="MaxListenersExceededWarning",i.emitter=this,i.count=e,r.emitWarning(i)}else console.error(n),console.trace&&console.trace()}function l(e){this._events={},this.newListener=!1,this.verboseMemoryLeak=!1,a.call(this,e)}function h(e,t,n,r){if(!n)return[];var i,s,o,a,c,l,f,u=[],d=t.length,m=t[r],p=t[r+1];if(r===d&&n._listeners){if("function"==typeof n._listeners)return e&&e.push(n._listeners),[n];for(i=0,s=n._listeners.length;i<s;i++)e&&e.push(n._listeners[i]);return[n]}if("*"===m||"**"===m||n[m]){if("*"===m){for(o in n)"_listeners"!==o&&n.hasOwnProperty(o)&&(u=u.concat(h(e,t,n[o],r+1)));return u}if("**"===m){f=r+1===d||r+2===d&&"*"===p,f&&n._listeners&&(u=u.concat(h(e,t,n,d)));for(o in n)"_listeners"!==o&&n.hasOwnProperty(o)&&("*"===o||"**"===o?(n[o]._listeners&&!f&&(u=u.concat(h(e,t,n[o],d))),u=u.concat(h(e,t,n[o],r))):u=o===p?u.concat(h(e,t,n[o],r+2)):u.concat(h(e,t,n[o],r)));return u}u=u.concat(h(e,t,n[m],r+1))}if(a=n["*"],a&&h(e,t,a,r+1),c=n["**"])if(r<d){c._listeners&&h(e,t,c,d);for(o in c)"_listeners"!==o&&c.hasOwnProperty(o)&&(o===p?h(e,t,c[o],r+2):o===m?h(e,t,c[o],r+1):(l={},l[o]=c[o],h(e,t,{"**":l},r+1)))}else c._listeners?h(e,t,c,d):c["*"]&&c["*"]._listeners&&h(e,t,c["*"],d);return u}function f(e,t){e="string"==typeof e?e.split(this.delimiter):e.slice();for(var n=0,r=e.length;n+1<r;n++)if("**"===e[n]&&"**"===e[n+1])return;for(var i=this.listenerTree,o=e.shift();o!==s;){if(i[o]||(i[o]={}),i=i[o],0===e.length)return i._listeners?("function"==typeof i._listeners&&(i._listeners=[i._listeners]),i._listeners.push(t),!i._listeners.warned&&this._maxListeners>0&&i._listeners.length>this._maxListeners&&(i._listeners.warned=!0,c.call(this,i._listeners.length,o))):i._listeners=t,!0;o=e.shift()}return!0}var u=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},d=10;l.EventEmitter2=l,l.prototype.delimiter=".",l.prototype.setMaxListeners=function(e){e!==s&&(this._maxListeners=e,this._conf||(this._conf={}),this._conf.maxListeners=e)},l.prototype.event="",l.prototype.once=function(e,t){return this._once(e,t,!1)},l.prototype.prependOnceListener=function(e,t){return this._once(e,t,!0)},l.prototype._once=function(e,t,n){return this._many(e,1,t,n),this},l.prototype.many=function(e,t,n){return this._many(e,t,n,!1)},l.prototype.prependMany=function(e,t,n){return this._many(e,t,n,!0)},l.prototype._many=function(e,t,n,r){function i(){return 0==--t&&s.off(e,i),n.apply(this,arguments)}var s=this;if("function"!=typeof n)throw new Error("many only accepts instances of Function");return i._origin=n,this._on(e,i,r),s},l.prototype.emit=function(){this._events||o.call(this);var e=arguments[0];if("newListener"===e&&!this.newListener&&!this._events.newListener)return!1;var t,n,r,i,s,a=arguments.length;if(this._all&&this._all.length){if(s=this._all.slice(),a>3)for(t=new Array(a),i=0;i<a;i++)t[i]=arguments[i];for(r=0,n=s.length;r<n;r++)switch(this.event=e,a){case 1:s[r].call(this,e);break;case 2:s[r].call(this,e,arguments[1]);break;case 3:s[r].call(this,e,arguments[1],arguments[2]);break;default:s[r].apply(this,t)}}if(this.wildcard){s=[];var c="string"==typeof e?e.split(this.delimiter):e.slice();h.call(this,s,c,this.listenerTree,0)}else{if("function"==typeof(s=this._events[e])){switch(this.event=e,a){case 1:s.call(this);break;case 2:s.call(this,arguments[1]);break;case 3:s.call(this,arguments[1],arguments[2]);break;default:for(t=new Array(a-1),i=1;i<a;i++)t[i-1]=arguments[i];s.apply(this,t)}return!0}s&&(s=s.slice())}if(s&&s.length){if(a>3)for(t=new Array(a-1),i=1;i<a;i++)t[i-1]=arguments[i];for(r=0,n=s.length;r<n;r++)switch(this.event=e,a){case 1:s[r].call(this);break;case 2:s[r].call(this,arguments[1]);break;case 3:s[r].call(this,arguments[1],arguments[2]);break;default:s[r].apply(this,t)}return!0}if(!this._all&&"error"===e)throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");return!!this._all},l.prototype.emitAsync=function(){this._events||o.call(this);var e=arguments[0];if("newListener"===e&&!this.newListener&&!this._events.newListener)return Promise.resolve([!1]);var t,n,r,i,s,a=[],c=arguments.length;if(this._all){if(c>3)for(t=new Array(c),i=1;i<c;i++)t[i]=arguments[i];for(r=0,n=this._all.length;r<n;r++)switch(this.event=e,c){case 1:a.push(this._all[r].call(this,e));break;case 2:a.push(this._all[r].call(this,e,arguments[1]));break;case 3:a.push(this._all[r].call(this,e,arguments[1],arguments[2]));break;default:a.push(this._all[r].apply(this,t))}}if(this.wildcard){s=[];var l="string"==typeof e?e.split(this.delimiter):e.slice();h.call(this,s,l,this.listenerTree,0)}else s=this._events[e];if("function"==typeof s)switch(this.event=e,c){case 1:a.push(s.call(this));break;case 2:a.push(s.call(this,arguments[1]));break;case 3:a.push(s.call(this,arguments[1],arguments[2]));break;default:for(t=new Array(c-1),i=1;i<c;i++)t[i-1]=arguments[i];a.push(s.apply(this,t))}else if(s&&s.length){if(s=s.slice(),c>3)for(t=new Array(c-1),i=1;i<c;i++)t[i-1]=arguments[i];for(r=0,n=s.length;r<n;r++)switch(this.event=e,c){case 1:a.push(s[r].call(this));break;case 2:a.push(s[r].call(this,arguments[1]));break;case 3:a.push(s[r].call(this,arguments[1],arguments[2]));break;default:a.push(s[r].apply(this,t))}}else if(!this._all&&"error"===e)return arguments[1]instanceof Error?Promise.reject(arguments[1]):Promise.reject("Uncaught, unspecified 'error' event.");return Promise.all(a)},l.prototype.on=function(e,t){return this._on(e,t,!1)},l.prototype.prependListener=function(e,t){return this._on(e,t,!0)},l.prototype.onAny=function(e){return this._onAny(e,!1)},l.prototype.prependAny=function(e){return this._onAny(e,!0)},l.prototype.addListener=l.prototype.on,l.prototype._onAny=function(e,t){if("function"!=typeof e)throw new Error("onAny only accepts instances of Function");return this._all||(this._all=[]),t?this._all.unshift(e):this._all.push(e),this},l.prototype._on=function(e,t,n){if("function"==typeof e)return this._onAny(e,t),this;if("function"!=typeof t)throw new Error("on only accepts instances of Function");return this._events||o.call(this),this.emit("newListener",e,t),this.wildcard?(f.call(this,e,t),this):(this._events[e]?("function"==typeof this._events[e]&&(this._events[e]=[this._events[e]]),n?this._events[e].unshift(t):this._events[e].push(t),!this._events[e].warned&&this._maxListeners>0&&this._events[e].length>this._maxListeners&&(this._events[e].warned=!0,c.call(this,this._events[e].length,e))):this._events[e]=t,this)},l.prototype.off=function(e,t){function n(e){if(e!==s){var t=Object.keys(e);for(var r in t){var i=t[r],o=e[i];o instanceof Function||"object"!=typeof o||null===o||(Object.keys(o).length>0&&n(e[i]),0===Object.keys(o).length&&delete e[i])}}}if("function"!=typeof t)throw new Error("removeListener only takes instances of Function");var r,i=[];if(this.wildcard){var o="string"==typeof e?e.split(this.delimiter):e.slice();i=h.call(this,null,o,this.listenerTree,0)}else{if(!this._events[e])return this;r=this._events[e],i.push({_listeners:r})}for(var a=0;a<i.length;a++){var c=i[a];if(r=c._listeners,u(r)){for(var l=-1,f=0,d=r.length;f<d;f++)if(r[f]===t||r[f].listener&&r[f].listener===t||r[f]._origin&&r[f]._origin===t){l=f;break}if(l<0)continue;return this.wildcard?c._listeners.splice(l,1):this._events[e].splice(l,1),0===r.length&&(this.wildcard?delete c._listeners:delete this._events[e]),this.emit("removeListener",e,t),this}(r===t||r.listener&&r.listener===t||r._origin&&r._origin===t)&&(this.wildcard?delete c._listeners:delete this._events[e],this.emit("removeListener",e,t))}return n(this.listenerTree),this},l.prototype.offAny=function(e){var t,n=0,r=0;if(e&&this._all&&this._all.length>0){for(t=this._all,n=0,r=t.length;n<r;n++)if(e===t[n])return t.splice(n,1),this.emit("removeListenerAny",e),this}else{for(t=this._all,n=0,r=t.length;n<r;n++)this.emit("removeListenerAny",t[n]);this._all=[]}return this},l.prototype.removeListener=l.prototype.off,l.prototype.removeAllListeners=function(e){if(0===arguments.length)return!this._events||o.call(this),this;if(this.wildcard)for(var t="string"==typeof e?e.split(this.delimiter):e.slice(),n=h.call(this,null,t,this.listenerTree,0),r=0;r<n.length;r++){var i=n[r];i._listeners=null}else this._events&&(this._events[e]=null);return this},l.prototype.listeners=function(e){if(this.wildcard){var t=[],n="string"==typeof e?e.split(this.delimiter):e.slice();return h.call(this,t,n,this.listenerTree,0),t}return this._events||o.call(this),this._events[e]||(this._events[e]=[]),u(this._events[e])||(this._events[e]=[this._events[e]]),this._events[e]},l.prototype.eventNames=function(){return Object.keys(this._events)},l.prototype.listenerCount=function(e){return this.listeners(e).length},l.prototype.listenersAny=function(){return this._all?this._all:[]},(i=function(){return l}.call(t,n,t,e))!==s&&(e.exports=i)}()}).call(t,n(3))},function(e,t,n){"use strict";function r(){var e=arguments;if(1==e.length)var t={init:a},n=e[0];else var t=e[0],n=e[1];var u={};-1!==[Error,EvalError,RangeError,ReferenceError,SyntaxError,TypeError,URIError].indexOf(t)&&(t=i(t,u));var d="function"==typeof t;n[c]=d?t[c]:t;var m=new n(t);u.name=m.name,!m[h]&&d&&(m[h]=function(){t.apply(this,arguments)});var p=function(){};p[c]=m;var v=m.name?m.name:"";if(m[h]===o||m[h]===a)var y=new Function("F","return function "+v+"(){return new F()}")(p);else var y=new Function("F","i","u","n","return function "+v+"(){ var x=new F(),r=i.apply(x,arguments)\nif(r===n)\nreturn x\nelse if(r===u)\nreturn n\nelse\nreturn r\n}")(p,m[h],r[l]);m.constructor=y;for(var g in m)s(y,m,g);for(var g in t)f.call(t,g)&&y[g]===o&&s(y,t,g);return y.parent=t,y[c]=m,y}function i(e,t){function n(){var n=new e(arguments[0]);return n.name=t.name,this.message=n.message,Object.defineProperty?Object.defineProperty(this,"stack",{get:function(){return n.stack},configurable:!0}):this.stack=n.stack,this}var r=function(){};return r.prototype=e.prototype,n.prototype=new r,n}function s(e,t,n){try{var r=Object.getOwnPropertyDescriptor(t,n);r.get!==o||r.get!==o&&Object.defineProperty!==o?Object.defineProperty(e,n,r):e[n]=t[n]}catch(e){}}var o,a=function(){},c="prototype",l="undefined",h="init",f={}.hasOwnProperty;r[l]={},e.exports=r},function(e,t,n){function r(e,t){if(t>e.maxId){var n="Id greater than ";e.maxId===d?n+="2^53":n+=e.maxId}else if(e.server){if(t%2!=1)var n="Id from client not odd"}else if(t%2!=0)var n="Id from server not even";return void 0===n||(e.fire("error",{message:"rpepInvalidId",reason:n}),!1)}function i(e){var t=s("unparsableCommand","'"+e+"'");return t.name="UnparsableCommand",t}function s(e,t){var n=new Error(t||e);return n.code=e,n}var o=n(0),a=n(1),c=n(4),l=n(5),h=0,f=1,u=2,d=9007199254740992,m={close:1,idDiscontinuity:1},p={close:1,idDiscontinuity:1},v={error:1},y={close:1},g={idDiscontinuity:1},w={order:1},_={orderNumberDiscontinuity:1},b=a(Error,function(){this.name="PeerError"});e.exports=a(o,function(){function e(e,n,r,i){if(void 0!==e.commands[r])throw t('handler for "'+r+'"');if(r in y)throw new Error("Can't setup a handler for the command '"+r+"', because it's reserved for internal use.");if((n===f||n===u)&&r in g)throw new Error("Can't setup a receive or stream handler for the command '"+r+"', because it's reserved for as a receive command. If you'd like to listen for this command, use `receive`.");e.commands[r]={type:n,handler:i}}function t(e){return new Error("A "+e+" already exists! You can only have one handler per command.")}this.PeerError=b,this.init=function(e,t,n){o.call(this),n||(n={}),this.transport=e,this.serialization=t,this.options=n,void 0===this.options.maxId&&(this.options.maxId=d),void 0===this.options.sendCommandErrorInfo&&(this.options.sendCommandErrorInfo=!0),this.commands={}},this.connect=function(){var e=Array.prototype.slice.call(arguments),t=this;return new Promise(function(n,r){var i=t.transport.connect.apply(t.transport.connect,e.concat([t.options])),o=!1,a=[];i.onOpen(function(){o=!0,n(c)});var c=x(t,i,{isServer:!1,onClose:function(){if(!o){var e="Connection couldn't be opened";a.length>0&&(e+=": \n"+a.join("\n"));var t=s("connectionFailure",e);t.errors=a,r(t)}}});i.onError(function(e){a.push(e)})})},this.listen=function(){var e=Array.prototype.slice.call(arguments),t=e[e.length-1],n=e.slice(0,-1),r=this;return new Promise(function(e,i){if(void 0!==r.listener)throw new Error("Rpep object already listening!");r.listener=r.transport.listen.apply(r.transport,n.concat([r.options,function(e){t({accept:function(){var t=e.accept.apply(r,arguments);return x(r,t,{isServer:!0})},reject:function(){e.reject.apply(r,arguments)},rawRequest:e})}]));var s=!1;r.listener.onListening(function(){s=!0,r.emit("listening"),e()}),r.listener.onError(function(e){r.emit("error",e)}),r.listener.onClose(function(e){r.listener=void 0,r.emit("close"),!1===s&&i()})})},this.close=function(){this.listener&&this.listener.close()},this.receive=function(t,n){e(this,h,t,n)},this.respond=function(t,n){e(this,f,t,n)},this.stream=function(t,n){if(!(n instanceof Function))throw new Error("rpep.stream requires a callback as the second argument");e(this,u,t,n)},this.default=function(e){if(void 0!==this.defaultHandler)throw t("default handler");this.defaultHandler=e},this.preHandle=function(e){if(void 0!==this.preHandler)throw t("preHandle");this.preHandler=e},this.rawHandle=function(e){if(void 0!==this.rawHandler)throw t("rawHandle");this.rawHandler=e}});var x=a(o,function(){function e(e,t){return e.serialization.serialize(t)}function t(e,t){return e.serialization.deserialize(t)}function n(e){void 0!==e.closeTimeoutHandle&&clearTimeout(e.closeTimeoutHandle);var t=Object.keys(e.commandState);if(t.length>0){var n="Connection has been closed after a "+e.closeTimeout+"ms timeout and some pending requests and streams remain unfulfilled. The following requests and streams were still active up until the timeout:\n",r=[];for(var i in e.commandState){var s=e.commandState[i];s instanceof E?s.endMessageSent?r.push("* Stream "+i+" '"+s.command+"' waiting for other side to 'end'"):s.endMessageReceived?r.push("* Stream "+i+" '"+s.command+"' has received 'end' but hasn't sent 'end'"):r.push("* Stream "+i+" '"+s.command+"' is still active"):void 0!==s.f?r.push("* Request "+i+" to '"+s.command+"'"):r.push("* Response "+i+" for '"+s.command+"'")}n+=r.join("\n");var o=new Error(n);o.ids=t,e.commandState={},e.emit("error",o)}void 0===e.connection.onClose&&L(e,["close"]),e.connection.close(),e.connection=void 0}function a(e){e.closing&&0===Object.keys(e.commandState).length&&n(e)}function l(e){var t=e.nextId;do{e.nextId+=2,e.nextId>e.maxId&&(e.nextId=e.nextId%2)}while(e.nextId in e.commandState&&t!==e.nextId);if(t===e.nextId)throw new Error("No valid rpep IDs left to use.");e.nextId!==t+2&&L(e,["idDiscontinuity",[t,e.nextId]])}function d(e,t){var n=Array.prototype.slice.call(t,1);1===n.length?e.push(n[0]):n.length>1&&e.push(n)}function y(e){return void 0===e?[]:e instanceof Array?e:[e]}function g(e,t){if(t.nextOrderNumber+=1,t.nextOrderNumber>e.maxId){var n=t.nextOrderNumber-1;t.nextOrderNumber=0,I(e,t,t.id,"orderNumberDiscontinuity",["",n,t.nextOrderNumber])}}function w(e){var t={},n=!1;for(var r in e)"message"!==r&&(t[r]=e[r],n=!0);var i=[e.message];return n&&i.push(t),i}function x(e,t){var n=new Error(e);for(var r in t)"message"!==r&&(n[r]=t[r]);return n}function S(e,t){var n=E(function(r){if(n.endMessageSent)throw new Error("Stream 'end' event has been sent, can't send more events.");if(r in _)throw new Error("Can't emit the '"+r+"' event directly; '"+r+"' is reserved for internal use.");if("error"===r){if(void 0===arguments[1].message)throw new Error("The data for an 'error' event must have a 'message' property (eg an Error object has a message property)");if(2!==arguments.length)throw new Error("An 'error' event can only take one argument - the error.")}I(e,n,t,r,arguments)});return n.id=t,n.orderingData=!1,n.nextOrderNumber=0,n.endMessageSent=!1,n}function L(t,n){var r=e(t,n);if(void 0!==t.maxSendSize&&r.length>t.maxSendSize){var i=s("maxMessageSizeExceeded");throw i.messageSize=r.length,i}if(!t.connected)throw Error("Connection is closed");t.connection.send(r)}function I(e,t,n,r,i){var s=[n];t.orderingData&&s.push(t.nextOrderNumber),s.push(r),"error"===r?s.push(w(i[1])):d(s,i),L(e,s),"end"===r?(t.endMessageSent=!0,t.endMessageReceived&&(delete e.commandState[n],a(e))):t.orderingData&&g(e,t)}function k(e,n){try{if(e.rawHandler&&"ignore"===e.rawHandler.call(e,n))return;try{var o=t(e,n)}catch(t){if(e.sendCommandErrorInfo)try{e.fire("error",{message:"unparsableCommand",rawMessage:n})}catch(t){if("maxMessageSizeExceeded"!==t.message)throw t;e.fire("error",{message:"unparsableCommand",rawMessage:n.slice(0,200)})}return void e.emit("error",i(n))}if(e.preHandler&&"ignore"===e.preHandler.call(e,o))return;var c=typeof o[0];if("string"===c){if(1===o.length&&"close"===o[0])return void e.emit("closeMessage");var l=e.commands[o[0]];if(void 0===l){if(void 0!==e.defaultHandler)return void e.defaultHandler.call(e,o);if("error"===o[0])throw x(o[1],o[2]);return void("idDiscontinuity"!==o[0]&&e.fire("error",{message:"noSuchCommand",command:o[0]}))}if(l.type===h){if("error"===o[0])var d=[x(o[1],o[2])];else var d=y(o[1]);l.handler.apply(e,d)}else if(l.type===f){var m=o[1];if(!r(e,m))return;e.commandState[m]={command:o[0]},Promise.resolve().then(function(){return l.handler.apply(e,y(o[2]).concat([m]))}).then(function(t){delete e.commandState[m],L(e,[m,t])}).catch(function(t){if(delete e.commandState[m],t instanceof b)var n=w(t);else{var n=["unexpectedPeerError",{}];e.emit("error",t)}L(e,[m].concat(n))})}else{if(l.type!==u)throw s("invalidCommandType","Invalid command type: "+l.type);var m=o[1];if(!r(e,m))return;var p=e.commandState[m]=S(e,m);p.command=o[0];try{l.handler.apply(e,[p].concat(y(o[2])).concat([m]))}catch(t){e.emit("error",t)}}}else if("number"===c){if(!(o[0]in e.commandState))return void e.fire("error",{message:"rpepIdNotFound",id:o[0]});var v=e.commandState[o[0]];if(v instanceof E){var p=v;if("string"==typeof o[1])var g=o[1],_=o[2];else{if("string"!=typeof o[2])throw s("invalidStreamMessage","Received invalid stream message: couldn't find string event name at position 1 or 2 in the message");var I=o[1],g=o[2],_=o[3]}if("order"===g)p.orderingData=!0===_;else if("error"===g){var k=x(_[0],_[1]);p._external.emit("error",k,I)}else{var T=[g];void 0!==_&&(T=T.concat(_)),void 0!==I&&T.push(I),p._external.emit.apply(p._external,T),"end"===g&&(p.endMessageReceived=!0,p.endMessageSent&&(delete e.commandState[o[0]],a(e)))}}else{if(void 0===v.f)throw new Error("Shouldn't get here "+JSON.stringify(v));var A=v;3===o.length?A.reject(x(o[1],o[2])):A.resolve(o[1]),delete e.commandState[o[0]],a(e)}}else e.emit("error",i(n)),e.sendCommandErrorInfo?e.fire("error",{message:"invalidMessage",rawMessage:n.slice(0,200)}):e.fire("error",{message:"invalidMessage"})}catch(t){e.emit("error",t)}}this.init=function(e,t,n){o.call(this),this.transport=e.transport,this.serialization=e.serialization,this.commands=e.commands,this.defaultHandler=e.defaultHandler,this.preHandler=e.preHandler,this.rawHandler=e.rawHandler,this.maxSendSize=e.options.maxSendSize,this.maxReceiveSize=e.options.maxReceiveSize,this.sendCommandErrorInfo=e.options.sendCommandErrorInfo,this.maxId=e.options.maxId,this.closeTimeout=e.options.closeTimeout||3e4,this.server=n.isServer,this.connection=t,this.connected=!0,this.closing=!1,this.sessionData={},this.commandState={};var r=!1;Object.defineProperty(this,"rawConnection",{get:function(){return this.connection.rawConnection}}),this.server?this.nextId=0:this.nextId=1;var i=this;this.connection.onClose?this.connection.onClose(function(){n.onClose&&n.onClose(),i.connected=!1,i.emit("close")}):this.on("closeMessage",function(){i.connected=!1,i.emit("close")}),this.connection.onMessage(function(e){k(i,e)}),this.connection.onOpen(function(){r=!0}),this.connection.onError(function(e){r&&i.emit("error",e)})},this.close=function(){var e=this;this.connected&&!this.closing&&(this.closing=!0,0===Object.keys(this.commandState).length?n(this):this.closeTimeoutHandle=setTimeout(function(){e.closeTimeoutHandle=void 0,n(e)},this.closeTimeout))},this.drop=function(){this.connected&&this.connection.drop?this.connection.drop():this.close()},this.fire=function(e){if("error"===e){if(void 0===arguments[1].message)throw new Error("The data for an 'error' fire-and-forget message must have a 'message' property (eg an Error object has a message property)");if(2!==arguments.length)throw new Error("An 'error' fire-and-forget message can only take one argument - the error.")}if(e in m)throw new Error("Can't fire an '"+e+"' event directly; '"+e+"' is a global command reserved for internal use.");var t=[e];if("error"===e){var n=arguments[1],r={};for(var i in n)"message"!==i&&(r[i]=n[i]);t.push(n.message,r)}else d(t,arguments);L(this,t)},this.request=function(e){if(e in p)throw new Error("Can't do a '"+e+"' request directly; '"+e+"' is a global command reserved for internal use.");if(e in v)throw new Error("Can't do an 'error' request; 'error' is reserved for global fire-and-forget errors.");if(void 0!==this.commandState[this.nextId])throw new Error("There is already a callback for id: "+this.nextId);var t=[e,this.nextId];d(t,arguments),L(this,t);var n=c.resolver();return n.command=e,this.commandState[this.nextId]=n,l(this),n.f},this.streamConnect=function(e){if(e in p)throw new Error("Can't open a '"+e+"' stream directly; '"+e+"' is a global command reserved for internal use.");if(e in v)throw new Error("Can't open an 'error' stream; 'error' is reserved for global fire-and-forget errors.");if(void 0!==this.commandState[this.nextId])throw new Error("There is already a callback for id: "+this.nextId);var t=[e,this.nextId];d(t,arguments);var n=this.commandState[this.nextId]=S(this,this.nextId);return n.command=e,L(this,t),l(this),n}}),E=a(l,function(e){this.on=function(t,n){if(t in w)throw new Error("Can't listen on the '"+t+"' event directly; the '"+t+"' event is reserved for internal use.");e.on.call(this,t,n)},this.onAny=function(t){e.onAny.call(this,function(e){e in w||t.apply(this,arguments)}.bind(this))}})},function(e,t){function n(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function i(e){if(h===setTimeout)return setTimeout(e,0);if((h===n||!h)&&setTimeout)return h=setTimeout,setTimeout(e,0);try{return h(e,0)}catch(t){try{return h.call(null,e,0)}catch(t){return h.call(this,e,0)}}}function s(e){if(f===clearTimeout)return clearTimeout(e);if((f===r||!f)&&clearTimeout)return f=clearTimeout,clearTimeout(e);try{return f(e)}catch(t){try{return f.call(null,e)}catch(t){return f.call(this,e)}}}function o(){p&&d&&(p=!1,d.length?m=d.concat(m):v=-1,m.length&&a())}function a(){if(!p){var e=i(o);p=!0;for(var t=m.length;t;){for(d=m,m=[];++v<t;)d&&d[v].run();v=-1,t=m.length}d=null,p=!1,s(e)}}function c(e,t){this.fun=e,this.array=t}function l(){}var h,f,u=e.exports={};!function(){try{h="function"==typeof setTimeout?setTimeout:n}catch(e){h=n}try{f="function"==typeof clearTimeout?clearTimeout:r}catch(e){f=r}}();var d,m=[],p=!1,v=-1;u.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];m.push(new c(e,t)),1!==m.length||p||i(a)},c.prototype.run=function(){this.fun.apply(null,this.array)},u.title="browser",u.browser=!0,u.env={},u.argv=[],u.version="",u.versions={},u.on=l,u.addListener=l,u.once=l,u.off=l,u.removeListener=l,u.removeAllListeners=l,u.emit=l,u.prependListener=l,u.prependOnceListener=l,u.listeners=function(e){return[]},u.binding=function(e){throw new Error("process.binding is not supported")},u.cwd=function(){return"/"},u.chdir=function(e){throw new Error("process.chdir is not supported")},u.umask=function(){return 0}},function(e,t){function n(e){var t=[];for(var n in e)void 0!==e[n]&&Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t}t.resolver=function(){var e,t;return{f:new Promise(function(n,r){e=n,t=r}),resolve:e,reject:t}},t.equal=function(e,r){if(e instanceof Array){if(!(r instanceof Array))return!1;if(e.length!==r.length)return!1;for(var i=0;i<e.length;i++)if(!t.equal(e[i],r[i]))return!1;return!0}if(e instanceof Object){if(!(r instanceof Object))return!1;var s=n(e),o=n(r);if(s.length!==o.length)return!1;for(var i=0;i<s.length;i++){var a=s[i],c=e[a],l=r[a];if(!t.equal(c,l))return!1}return!0}return e===r||Number.isNaN(e)&&Number.isNaN(r)}},function(e,t,n){var r=n(1),i=n(0);e.exports=r(function(){this.init=function(e){this._external=new i({newListener:!1}),this._onEmitHandler=e},this.emit=function(e){if(this.ended)throw new Error("Duplex Stream has already been ended.");this._onEmitHandler.apply(this._onEmitHandler,arguments)},this.on=function(e,t){this._external.on(e,t)},this.off=this.removeListener=function(e,t){this._external.removeListener(e,t)},this.onAny=function(e){this._external.onAny(e)},this.offAny=function(e){this._external.offAny(e)}})}])});